<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>PDFs subidos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
    }

    :root {
      --bg-main: #020617;
      --card-bg: #020617f2;
      --card-border: #1f2937;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.12);
      --accent-2: #8b5cf6;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --surface-soft: #020617;
      --radius-lg: 16px;
      --radius-full: 999px;
      --shadow-soft: 0 24px 60px rgba(0, 0, 0, 0.7);
    }

    body {
      margin: 0;
      padding: 24px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #020617 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow-x: hidden;
    }

    /* Fondo animado aurora */
    .bg-aurora {
      position: fixed;
      inset: 0;
      z-index: -2;
      overflow: hidden;
      pointer-events: none;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #000 100%);
    }

    .aurora-blob {
      position: absolute;
      width: 420px;
      height: 420px;
      border-radius: 50%;
      filter: blur(60px);
      opacity: 0.65;
      mix-blend-mode: screen;
      animation: float 18s ease-in-out infinite alternate;
    }

    .aurora-blob:nth-child(1) {
      background: #4c1d95;
      top: -80px;
      left: -120px;
      animation-delay: 0s;
    }

    .aurora-blob:nth-child(2) {
      background: #0369a1;
      top: 40%;
      right: -140px;
      animation-delay: 3s;
    }

    .aurora-blob:nth-child(3) {
      background: #15803d;
      bottom: -160px;
      left: 10%;
      animation-delay: 6s;
    }

    @keyframes float {
      0% {
        transform: translate3d(0, 0, 0) scale(1);
      }
      50% {
        transform: translate3d(20px, -20px, 0) scale(1.05);
      }
      100% {
        transform: translate3d(-10px, 20px, 0) scale(1.1);
      }
    }

    .page-shell {
      width: 100%;
      max-width: 960px;
      margin: 0 auto;
    }

    .card {
      background: var(--card-bg);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow: var(--shadow-soft);
      padding: 20px 20px 24px;
      backdrop-filter: blur(24px);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(56, 189, 248, 0.07), transparent 55%);
      opacity: 0.85;
      pointer-events: none;
      z-index: -1;
    }

    @media (min-width: 768px) {
      .card {
        padding: 24px 28px 28px;
      }
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
    }

    h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.02em;
      background: linear-gradient(120deg, #e5e7eb, #c4b5fd, #38bdf8);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-weight: 600;
    }

    .subtitle {
      margin: 4px 0 0;
      font-size: 13px;
      color: var(--text-muted);
    }

    .top-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      text-align: right;
    }

    .pill {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: var(--radius-full);
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.7);
      color: var(--text-muted);
    }

    .refresh-button {
      padding: 6px 12px;
      border-radius: var(--radius-full);
      border: 1px solid var(--accent);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      cursor: pointer;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease, border-color 0.15s ease;
      box-shadow: 0 0 0 0 rgba(56, 189, 248, 0);
    }

    .refresh-button:hover {
      background: #020617;
      transform: translateY(-1px);
      box-shadow: 0 8px 24px rgba(56, 189, 248, 0.25);
      border-color: #7dd3fc;
    }

    .refresh-button span.icon {
      font-size: 14px;
      transform-origin: center;
      transition: transform 0.2s ease;
    }

    .refresh-button:hover span.icon {
      transform: rotate(-35deg);
    }

    #upload-area {
      border-radius: 18px;
      padding: 20px;
      margin-bottom: 18px;
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.07), rgba(2, 6, 23, 0.96));
      border: 1px dashed rgba(148, 163, 184, 0.55);
      text-align: center;
      transition: background 0.18s ease, border-color 0.18s ease, transform 0.18s ease;
      position: relative;
      overflow: hidden;
    }

    #upload-area::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, rgba(56, 189, 248, 0.12), transparent 40%, rgba(129, 140, 248, 0.16));
      mix-blend-mode: soft-light;
      opacity: 0.6;
      pointer-events: none;
    }

    #upload-area p {
      margin: 0 0 10px;
      font-size: 13px;
      color: var(--text-muted);
    }

    #upload-area.drag-over {
      background: radial-gradient(circle at top, rgba(56, 189, 248, 0.18), #020617);
      border-color: var(--accent);
      transform: translateY(-1px);
    }

    .upload-actions {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      margin-top: 6px;
    }

    button {
      padding: 7px 14px;
      border-radius: var(--radius-full);
      border: 1px solid var(--accent);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      cursor: pointer;
      font-size: 13px;
      position: relative;
      overflow: hidden;
      transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease, border-color 0.15s ease, opacity 0.15s ease;
    }

    button:hover:not(:disabled) {
      background: #020617;
      transform: translateY(-1px);
      box-shadow: 0 8px 24px rgba(56, 189, 248, 0.25);
      border-color: #7dd3fc;
    }

    #upload-button {
      min-width: 116px;
      border-color: #22c55e;
      background: rgba(5, 46, 22, 0.75);
    }

    #upload-button:hover:not(:disabled) {
      background: rgba(5, 46, 22, 0.95);
      box-shadow: 0 8px 24px rgba(34, 197, 94, 0.35);
      border-color: #4ade80;
    }

    #upload-button .label {
      position: relative;
      z-index: 2;
    }

    #upload-button .progress-bg {
      position: absolute;
      inset: 0;
      width: 0%;
      background: linear-gradient(90deg, #22c55e, #38bdf8);
      transition: width 0.15s ease-out;
      z-index: 1;
      opacity: 0.9;
    }

    #upload-status {
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .success-pulse {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      border-radius: var(--radius-full);
      background: #22c55e;
      color: #022c22;
      font-size: 13px;
      margin-left: 8px;
      animation: pulse 0.9s ease-out 1;
      box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
    }

    @keyframes pulse {
      0% {
        transform: scale(0.88);
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.6);
      }
      70% {
        transform: scale(1.06);
        box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
      }
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      background: var(--surface-soft);
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid var(--card-border);
      font-size: 13px;
    }

    thead {
      background: linear-gradient(90deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
    }

    th,
    td {
      padding: 9px 11px;
      border-bottom: 1px solid #111827;
    }

    th {
      text-align: left;
      font-weight: 500;
      color: #9ca3af;
      font-size: 12px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    tr {
      transition: background 0.12s ease;
    }

    tr:hover td {
      background: rgba(15, 23, 42, 0.96);
    }

    a {
      color: var(--accent);
      text-decoration: none;
      position: relative;
    }

    a::after {
      content: "";
      position: absolute;
      left: 0;
      bottom: -2px;
      width: 0;
      height: 1px;
      background: var(--accent);
      transition: width 0.14s ease;
    }

    a:hover::after {
      width: 100%;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 10px;
      border-radius: var(--radius-full);
      font-size: 11px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: var(--text-main);
      text-transform: lowercase;
      letter-spacing: 0.02em;
    }

    .tag::before {
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 999px;
      margin-right: 6px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.18);
    }

    /* Botón "Convertir a chunks" en la tabla */
.chunk-row-button {
  margin-left: 6px;
  font-size: 12px;
  padding: 4px 10px;
  border-radius: var(--radius-full);
  border: 1px solid var(--accent);
  background: rgba(15, 23, 42, 0.95);
  color: var(--text-main);
  cursor: pointer;
  transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease, border-color 0.15s ease;
}

.chunk-row-button:hover:not(:disabled) {
  background: #020617;
  transform: translateY(-1px);
  box-shadow: 0 8px 24px rgba(56, 189, 248, 0.25);
  border-color: #7dd3fc;
}

.chunk-row-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  border-color: #4b5563;
  box-shadow: none;
}


    @media (max-width: 640px) {
      body {
        padding: 16px;
      }

      .card {
        padding: 18px 14px 20px;
        border-radius: 18px;
      }

      .top-bar {
        flex-direction: column;
        align-items: flex-start;
      }

      .top-right {
        align-items: flex-start;
        text-align: left;
      }

      table {
        font-size: 12px;
      }

      th,
      td {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <!-- Fondo animado -->
  <div class="bg-aurora">
    <div class="aurora-blob"></div>
    <div class="aurora-blob"></div>
    <div class="aurora-blob"></div>
  </div>

  <!-- Navbar -->
  <nav style="position: fixed; top: 0; left: 0; right: 0; z-index: 1000; background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(148, 163, 184, 0.2); padding: 12px 24px;">
    <div style="max-width: 960px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; gap: 16px;">
      <div style="display: flex; align-items: center; gap: 16px;">
        <a href="/index.html" style="color: var(--accent); text-decoration: none; font-weight: 600;">Vector RAG</a>
        <span style="color: var(--text-muted);">|</span>
        <span id="navUserName" style="color: var(--text-main); font-size: 0.9rem;"></span>
      </div>
      <div style="display: flex; align-items: center; gap: 12px;">
        <a href="/rag.html" style="color: var(--text-main); text-decoration: none; font-size: 0.9rem; padding: 6px 12px; border-radius: 8px; transition: background 0.2s;" onmouseover="this.style.background='rgba(56, 189, 248, 0.1)'" onmouseout="this.style.background='transparent'">RAG</a>
        <button id="logoutBtn" style="padding: 6px 12px; border-radius: 8px; border: 1px solid var(--accent); background: transparent; color: var(--accent); cursor: pointer; font-size: 0.9rem; transition: all 0.2s;" onmouseover="this.style.background='rgba(56, 189, 248, 0.1)'" onmouseout="this.style.background='transparent'">Cerrar Sesión</button>
      </div>
    </div>
  </nav>

  <div class="page-shell" style="margin-top: 60px;">
    <div class="card">
      <div class="top-bar">
        <div>
          <h1>PDFs subidos</h1>
          <p class="subtitle">Gestiona y consulta los documentos que has cargado al sistema.</p>
        </div>
        <div class="top-right">
          <div class="pill">Arrastra y suelta archivos PDF para subirlos rápidamente</div>
          <button class="refresh-button" onclick="loadPdfs()">
            <span class="icon">⟲</span>
            <span>Recargar lista</span>
          </button>
        </div>
      </div>

      <div id="upload-area">
        <p>Arrastra aquí un PDF o haz clic para buscarlo en tu ordenador.</p>
        <div class="upload-actions">
          <input id="pdf-input" type="file" accept="application/pdf" style="display: none" />
          <button id="select-pdf-button" type="button">Seleccionar PDF</button>
          <button
            id="upload-button"
            type="button"
            disabled
            style="opacity: 0.5; cursor: not-allowed;"
          >
            <span class="progress-bg" id="upload-button-progress"></span>
            <span class="label" id="upload-button-label">Subir PDF</span>
          </button>
        </div>
        <p id="upload-status"></p>
      </div>

      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Tamaño</th>
            <th>Estado</th>
            <th>Fecha</th>
            <th>Ver</th>
            <th>Rag</th>
          </tr>
        </thead>
        <tbody id="pdf-tbody">
          <tr>
            <td colspan="5">Cargando...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Script de autenticación -->
  <script type="module">
    import { checkAuth, getUser, logout, fetchWithAuth } from '/js/auth.js';

    // Verificar autenticación al cargar
    if (!checkAuth()) {
      // Redirigirá automáticamente a login
    } else {
      // Mostrar nombre de usuario en navbar
      const user = getUser();
      if (user) {
        document.getElementById('navUserName').textContent = user.name || user.email;
      }
    }

    // Configurar event listener para logout cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', () => {
      const logoutButton = document.getElementById('logoutBtn');
      if (logoutButton) {
        logoutButton.addEventListener('click', (e) => {
          e.preventDefault();
          logout();
        });
      }
    });

    // Exportar fetchWithAuth para usar en el código inline
    window.fetchWithAuth = fetchWithAuth;
  </script>

  <script>
    let selectedPdfFile = null;

    async function uploadPdfFile(file) {
      const statusEl = document.getElementById("upload-status");
      const uploadButton = document.getElementById("upload-button");
      const uploadButtonProgress = document.getElementById("upload-button-progress");
      const uploadButtonLabel = document.getElementById("upload-button-label");

      // Reset estado UI
      uploadButtonProgress.style.width = "0%";
      statusEl.textContent = `Subiendo: ${file.name}...`;
      uploadButton.disabled = true;
      uploadButton.style.opacity = "0.7";
      uploadButton.style.cursor = "wait";
      uploadButtonLabel.textContent = "Subiendo...";

      const formData = new FormData();
      formData.append("pdf", file); // nombre de campo esperado por el backend

      try {
        const xhr = new XMLHttpRequest();
        const token = localStorage.getItem('rag_auth_token');

        xhr.open("POST", "/api/pdf/upload", true);
        
        if (token) {
          xhr.setRequestHeader("Authorization", `Bearer ${token}`);
        }

        xhr.upload.onprogress = (event) => {
          if (event.lengthComputable) {
            const percent = Math.round((event.loaded / event.total) * 100);
            uploadButtonProgress.style.width = `${percent}%`;
            statusEl.textContent = `Subiendo: ${file.name} (${percent}%)`;
          }
        };

        xhr.onreadystatechange = async () => {
          if (xhr.readyState === 4) {
            if (xhr.status >= 200 && xhr.status < 300) {
              let data;
              try {
                data = JSON.parse(xhr.responseText || "{}");
              } catch (e) {
                data = { ok: false, message: "Respuesta inválida del servidor" };
              }

              if (!data.ok) {
                throw new Error(data.message || "Error al subir el PDF");
              }

              uploadButtonProgress.style.width = "100%";
              statusEl.innerHTML = `PDF subido correctamente <span class="success-pulse">✓</span>`;
              uploadButtonLabel.textContent = "Subido";

              // limpiar selección
              selectedPdfFile = null;
              // recargar tabla
              await loadPdfs();

              // Reset visual después de un momento
              setTimeout(() => {
                uploadButtonProgress.style.width = "0%";
                uploadButtonLabel.textContent = "Subir PDF";
                uploadButton.disabled = true;
                uploadButton.style.opacity = "0.5";
                uploadButton.style.cursor = "not-allowed";
              }, 1200);
            } else {
              throw new Error("Error al subir el PDF");
            }
          }
        };

        xhr.onerror = () => {
          statusEl.textContent = "Error al subir el PDF (problema de red).";
          uploadButtonProgress.style.width = "0%";
          uploadButtonLabel.textContent = "Subir PDF";
          uploadButton.disabled = false;
          uploadButton.style.opacity = "1";
          uploadButton.style.cursor = "pointer";
        };

        xhr.send(formData);
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error al subir el PDF: " + err.message;
        uploadButtonProgress.style.width = "0%";
        uploadButtonLabel.textContent = "Subir PDF";
        uploadButton.disabled = false;
        uploadButton.style.opacity = "1";
        uploadButton.style.cursor = "pointer";
      }
    }
    
    async function processPdfFromRow(pdfId, button) {
      const statusEl = document.getElementById("upload-status");
      if (!pdfId) {
        statusEl.textContent = "No se encontró el ID del PDF para procesar.";
        return;
      }

      try {
        button.disabled = true;
        button.textContent = "Procesando...";
        button.style.opacity = "0.7";
        button.style.cursor = "wait";
        statusEl.textContent = "Procesando PDF en chunks...";

        const res = await fetchWithAuth(`/api/pdf/process/${pdfId}`, {
          method: "POST",
        });
        const data = await res.json();

        if (!res.ok || !data.ok) {
          throw new Error(data.message || "Error al procesar el PDF");
        }

        statusEl.innerHTML = `PDF procesado en ${data.chunks} chunks <span class="success-pulse">✓</span>`;

        await loadPdfs();

        setTimeout(() => {
          statusEl.textContent = "";
        }, 1500);
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error al procesar el PDF en chunks: " + err.message;
        button.disabled = false;
        button.textContent = "Convertir a chunks";
        button.style.opacity = "1";
        button.style.cursor = "pointer";
      }
    }

    function setupUploadArea() {
      const uploadArea = document.getElementById("upload-area");
      const fileInput = document.getElementById("pdf-input");
      const uploadButton = document.getElementById("upload-button");
      const selectPdfButton = document.getElementById("select-pdf-button");
      const statusEl = document.getElementById("upload-status");

      function setSelectedFile(file) {
        selectedPdfFile = file;
        if (file) {
          statusEl.textContent = `Seleccionado: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
          uploadButton.disabled = false;
          uploadButton.style.opacity = "1";
          uploadButton.style.cursor = "pointer";
        } else {
          statusEl.textContent = "";
          uploadButton.disabled = true;
          uploadButton.style.opacity = "0.5";
          uploadButton.style.cursor = "not-allowed";
        }
      }

      // Click en "Seleccionar PDF" - abre el diálogo de selección de archivos
      selectPdfButton.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        fileInput.click();
      });

      // Click en el área de upload - también abre el diálogo de selección de archivos
      uploadArea.addEventListener("click", (e) => {
        // Solo abrir el diálogo si el click no fue en un botón u otro elemento interactivo
        const clickedElement = e.target;
        const isButton = clickedElement.tagName === "BUTTON" || clickedElement.closest("button");
        const isInput = clickedElement.tagName === "INPUT";
        
        if (!isButton && !isInput) {
          fileInput.click();
        }
      });

      // Click en "Subir PDF"
      uploadButton.addEventListener("click", () => {
        if (!selectedPdfFile) {
          statusEl.textContent = "Primero selecciona un archivo PDF.";
          return;
        }
        uploadPdfFile(selectedPdfFile);
      });

      // Cambio por selección manual
      fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          if (file.type !== "application/pdf") {
            statusEl.textContent = "Solo se permiten archivos PDF.";
            setSelectedFile(null);
            return;
          }
          setSelectedFile(file);
        }
      });

      // Eventos drag & drop
      ["dragenter", "dragover"].forEach((eventName) => {
        uploadArea.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
          uploadArea.classList.add("drag-over");
        });
      });

      ["dragleave", "drop"].forEach((eventName) => {
        uploadArea.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
          uploadArea.classList.remove("drag-over");
        });
      });

      uploadArea.addEventListener("drop", (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        if (files && files[0]) {
          const file = files[0];
          if (file.type !== "application/pdf") {
            statusEl.textContent = "Solo se permiten archivos PDF.";
            setSelectedFile(null);
            return;
          }
          setSelectedFile(file);
        }
      });
    }

    async function loadPdfs() {
      const tbody = document.getElementById("pdf-tbody");
      tbody.innerHTML = "<tr><td colspan='5'>Cargando...</td></tr>";
      try {
        const res = await fetchWithAuth("/api/pdf");
        const data = await res.json();

        if (!data.ok) {
          tbody.innerHTML = `<tr><td colspan="5">Error: ${data.message}</td></tr>`;
          return;
        }

        if (!data.pdfs.length) {
          tbody.innerHTML = "<tr><td colspan='5'>No hay PDFs subidos aún.</td></tr>";
          return;
        }

        tbody.innerHTML = "";
        data.pdfs.forEach((pdf) => {
          const tr = document.createElement("tr");

          const sizeKb = (pdf.size / 1024).toFixed(1);

          const createdAt = pdf.createdAt
            ? new Date(pdf.createdAt).toLocaleString()
            : "-";

          const link = `/uploads/${pdf.fileName}`;
          
          const isProcessed = pdf.status === "processed";

tr.innerHTML = `
  <td>${pdf.originalName}</td>
  <td>${sizeKb} KB</td>
  <td><span class="tag">${pdf.status || "uploaded"}</span></td>
  <td>${createdAt}</td>
  <td>
    <a href="${link}" target="_blank">Abrir</a>
    <button
      class="chunk-row-button"
      data-pdf-id="${pdf._id || ""}"
      ${isProcessed
        ? "disabled style='margin-left:6px;opacity:0.5;cursor:not-allowed;'"
        : "style='margin-left:6px;'"}
    >
      Convertir a chunks
    </button>
  </td>
  <td>
    <button
      class="rag-button"
      data-pdf-id="${pdf._id || ""}"
      ${isProcessed
        ? ""
        : "disabled style='opacity:0.5;cursor:not-allowed;'"}
    >
      Enviar a Qdrant
    </button>
  </td>
`;


          tbody.appendChild(tr);
        });

        // asociar eventos a los botones "Convertir a chunks" de cada fila
        const chunkButtons = tbody.querySelectorAll(".chunk-row-button");
        chunkButtons.forEach((btn) => {
          const pdfId = btn.getAttribute("data-pdf-id");
          if (!pdfId || btn.disabled) return;
          btn.addEventListener("click", () => processPdfFromRow(pdfId, btn));
        });

       // asociar eventos a los botones "Enviar a Qdrant" (RAG)
const ragButtons = tbody.querySelectorAll(".rag-button");
ragButtons.forEach((btn) => {
  const pdfId = btn.getAttribute("data-pdf-id");
  if (!pdfId || btn.disabled) return;

  btn.addEventListener("click", async () => {
    const statusEl = document.getElementById("upload-status");
    try {
      btn.disabled = true;
      btn.textContent = "Embebiendo...";
      btn.style.opacity = "0.7";
      btn.style.cursor = "wait";
      statusEl.textContent = "Generando embeddings y enviando a Qdrant...";

      const res = await fetchWithAuth(`/api/pdf/embed/${pdfId}`, {
        method: "POST",
      });
      const data = await res.json();

      if (!res.ok || !data.ok) {
        throw new Error(data.message || "Error al generar embeddings");
      }

      statusEl.innerHTML = `Embeddings generados (${data.inserted}) <span class="success-pulse">✓</span>`;
      btn.textContent = "Enviado ✓";

      // refrescar listado para ver cambios de estado
      await loadPdfs();

      setTimeout(() => {
        statusEl.textContent = "";
      }, 2000);
    } catch (err) {
      console.error(err);
      statusEl.textContent = "Error al enviar a Qdrant: " + err.message;
      btn.disabled = false;
      btn.textContent = "Enviar a Qdrant";
      btn.style.opacity = "1";
      btn.style.cursor = "pointer";
    }
  });
});


      } catch (err) {
        console.error(err);
        tbody.innerHTML = "<tr><td colspan='5'>Error al cargar la lista.</td></tr>";
      }
    }

    // Evitar que el navegador abra el archivo al soltarlo fuera del área
    window.addEventListener("dragover", (e) => e.preventDefault());
    window.addEventListener("drop", (e) => e.preventDefault());

    // Inicializar al cargar
    document.addEventListener("DOMContentLoaded", () => {
      setupUploadArea();
      loadPdfs();
    });
  </script>
</body>
</html>

