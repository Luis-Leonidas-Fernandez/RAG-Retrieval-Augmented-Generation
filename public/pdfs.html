<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>DOCs subidos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
    }

    :root {
      --bg-main: #020617;
      --card-bg: #020617f2;
      --card-border: #1f2937;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.12);
      --accent-2: #8b5cf6;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --surface-soft: #020617;
      --radius-lg: 16px;
      --radius-full: 999px;
      --shadow-soft: 0 24px 60px rgba(0, 0, 0, 0.7);
    }

    body {
      margin: 0;
      padding: 24px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #020617 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow-x: hidden;
    }

    /* Fondo animado aurora */
    .bg-aurora {
      position: fixed;
      inset: 0;
      z-index: -2;
      overflow: hidden;
      pointer-events: none;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #000 100%);
    }

    .aurora-blob {
      position: absolute;
      width: 420px;
      height: 420px;
      border-radius: 50%;
      filter: blur(60px);
      opacity: 0.65;
      mix-blend-mode: screen;
      animation: float 18s ease-in-out infinite alternate;
    }

    .aurora-blob:nth-child(1) {
      background: #4c1d95;
      top: -80px;
      left: -120px;
      animation-delay: 0s;
    }

    .aurora-blob:nth-child(2) {
      background: #0369a1;
      top: 40%;
      right: -140px;
      animation-delay: 3s;
    }

    .aurora-blob:nth-child(3) {
      background: #15803d;
      bottom: -160px;
      left: 10%;
      animation-delay: 6s;
    }

    @keyframes float {
      0% {
        transform: translate3d(0, 0, 0) scale(1);
      }
      50% {
        transform: translate3d(20px, -20px, 0) scale(1.05);
      }
      100% {
        transform: translate3d(-10px, 20px, 0) scale(1.1);
      }
    }

    .page-shell {
      width: 100%;
      max-width: 960px;
      margin: 0 auto;
      overflow-x: hidden;
    }

    .card {
      background: var(--card-bg);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow: var(--shadow-soft);
      padding: 20px 20px 24px;
      backdrop-filter: blur(24px);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(56, 189, 248, 0.07), transparent 55%);
      opacity: 0.85;
      pointer-events: none;
      z-index: -1;
    }

    @media (min-width: 768px) {
      .card {
        padding: 24px 28px 28px;
      }
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 18px;
    }

    h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.02em;
      background: linear-gradient(120deg, #e5e7eb, #c4b5fd, #38bdf8);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-weight: 600;
    }

    .subtitle {
      margin: 4px 0 0;
      font-size: 13px;
      color: var(--text-muted);
    }

    .top-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      text-align: right;
    }

    .pill {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: var(--radius-full);
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.7);
      color: var(--text-muted);
    }

    .refresh-button {
      padding: 6px 12px;
      border-radius: var(--radius-full);
      border: 1px solid var(--accent);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      cursor: pointer;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease, border-color 0.15s ease;
      box-shadow: 0 0 0 0 rgba(56, 189, 248, 0);
    }

    .refresh-button:hover {
      background: #020617;
      transform: translateY(-1px);
      box-shadow: 0 8px 24px rgba(56, 189, 248, 0.25);
      border-color: #7dd3fc;
    }

    .refresh-button span.icon {
      font-size: 14px;
      transform-origin: center;
      transition: transform 0.2s ease;
    }

    .refresh-button:hover span.icon {
      transform: rotate(-35deg);
    }

    #upload-area {
      border-radius: 18px;
      padding: 20px;
      margin-bottom: 18px;
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.07), rgba(2, 6, 23, 0.96));
      border: 1px dashed rgba(148, 163, 184, 0.55);
      text-align: center;
      transition: background 0.18s ease, border-color 0.18s ease, transform 0.18s ease;
      position: relative;
      overflow: hidden;
    }

    #upload-area::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, rgba(56, 189, 248, 0.12), transparent 40%, rgba(129, 140, 248, 0.16));
      mix-blend-mode: soft-light;
      opacity: 0.6;
      pointer-events: none;
    }

    #upload-area p {
      margin: 0 0 10px;
      font-size: 13px;
      color: var(--text-muted);
    }

    #upload-area.drag-over {
      background: radial-gradient(circle at top, rgba(56, 189, 248, 0.18), #020617);
      border-color: var(--accent);
      transform: translateY(-1px);
    }

    .upload-actions {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      margin-top: 6px;
    }

    button {
      padding: 7px 14px;
      border-radius: var(--radius-full);
      border: 1px solid var(--accent);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      cursor: pointer;
      font-size: 13px;
      position: relative;
      overflow: hidden;
      transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease, border-color 0.15s ease, opacity 0.15s ease;
    }

    button:hover:not(:disabled) {
      background: #020617;
      transform: translateY(-1px);
      box-shadow: 0 8px 24px rgba(56, 189, 248, 0.25);
      border-color: #7dd3fc;
    }

    #upload-button {
      min-width: 116px;
      border-color: #22c55e;
      background: rgba(5, 46, 22, 0.75);
    }

    #upload-button:hover:not(:disabled) {
      background: rgba(5, 46, 22, 0.95);
      box-shadow: 0 8px 24px rgba(34, 197, 94, 0.35);
      border-color: #4ade80;
    }

    #upload-button .label {
      position: relative;
      z-index: 2;
    }

    #upload-button .progress-bg {
      position: absolute;
      inset: 0;
      width: 0%;
      background: linear-gradient(90deg, #22c55e, #38bdf8);
      transition: width 0.15s ease-out;
      z-index: 1;
      opacity: 0.9;
    }

    #upload-status {
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .success-pulse {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      border-radius: var(--radius-full);
      background: #22c55e;
      color: #022c22;
      font-size: 13px;
      margin-left: 8px;
      animation: pulse 0.9s ease-out 1;
      box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
    }

    @keyframes pulse {
      0% {
        transform: scale(0.88);
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.6);
      }
      70% {
        transform: scale(1.06);
        box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
      }
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      background: var(--surface-soft);
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid var(--card-border);
      font-size: 13px;
      display: block;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    thead {
      background: linear-gradient(90deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
      display: table;
      width: 100%;
      table-layout: fixed;
    }

    tbody {
      display: table-row-group;
    }

    th,
    td {
      padding: 9px 11px;
      border-bottom: 1px solid #111827;
    }

    th {
      text-align: left;
      font-weight: 500;
      color: #9ca3af;
      font-size: 12px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    tr {
      display: table-row;
      transition: background 0.12s ease;
    }

    tr:hover td {
      background: rgba(15, 23, 42, 0.96);
    }

    a {
      color: var(--accent);
      text-decoration: none;
      position: relative;
    }

    a::after {
      content: "";
      position: absolute;
      left: 0;
      bottom: -2px;
      width: 0;
      height: 1px;
      background: var(--accent);
      transition: width 0.14s ease;
    }

    a:hover::after {
      width: 100%;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 10px;
      border-radius: var(--radius-full);
      font-size: 11px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: var(--text-main);
      text-transform: lowercase;
      letter-spacing: 0.02em;
    }

    .tag::before {
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 999px;
      margin-right: 6px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.18);
    }

    /* Bot√≥n "Convertir a chunks" en la tabla */
.chunk-row-button {
  margin-left: 6px;
  font-size: 12px;
  padding: 4px 10px;
  border-radius: var(--radius-full);
  border: 1px solid var(--accent);
  background: rgba(15, 23, 42, 0.95);
  color: var(--text-main);
  cursor: pointer;
  transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease, border-color 0.15s ease;
}

.chunk-row-button:hover:not(:disabled) {
  background: #020617;
  transform: translateY(-1px);
  box-shadow: 0 8px 24px rgba(56, 189, 248, 0.25);
  border-color: #7dd3fc;
}

.chunk-row-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  border-color: #4b5563;
  box-shadow: none;
}


    @media (max-width: 640px) {
      body {
        padding: 12px;
      }

      .card {
        padding: 16px 12px 18px;
        border-radius: 18px;
      }

      .page-shell {
        margin-top: 50px;
      }

      .top-bar {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .top-right {
        align-items: flex-start;
        text-align: left;
        width: 100%;
      }

      table {
        font-size: 11px;
        display: block;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      th,
      td {
        padding: 6px 8px;
        white-space: nowrap;
        min-width: 80px;
      }

      th:nth-child(1), td:nth-child(1) {
        min-width: 120px;
      }

      th:nth-child(2), td:nth-child(2) {
        min-width: 60px;
      }

      th:nth-child(3), td:nth-child(3) {
        min-width: 70px;
      }

      th:nth-child(4), td:nth-child(4) {
        min-width: 100px;
      }

      th:nth-child(5), td:nth-child(5) {
        min-width: 140px;
      }

      th:nth-child(6), td:nth-child(6) {
        min-width: 100px;
      }
    }

    @media (min-width: 641px) and (max-width: 1024px) {
      body {
        padding: 16px;
      }

      .card {
        padding: 20px 18px 22px;
      }

      table {
        font-size: 12px;
      }

      th,
      td {
        padding: 8px 10px;
      }
    }

    /* Sidebar Menu */
    .menu-icon {
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      transition: background 0.2s ease;
      color: var(--accent);
      font-size: 20px;
      background: transparent;
      border: none;
      padding: 0;
    }

    .menu-icon:hover {
      background: rgba(56, 189, 248, 0.1);
    }

    .sidebar-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1500;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
      backdrop-filter: blur(4px);
    }

    .sidebar-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 280px;
      background: var(--card-bg);
      border-right: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: 4px 0 24px rgba(0, 0, 0, 0.5);
      z-index: 1501;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      padding: 20px;
      overflow-y: auto;
    }

    .sidebar.active {
      transform: translateX(0);
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    }

    .sidebar-title {
      font-size: 18px;
      font-weight: 600;
    }

    .sidebar-brand-name {
      background: linear-gradient(120deg, #e5e7eb, #c4b5fd, #38bdf8);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .sidebar-brand-number {
      color: #f59e0b;
      font-weight: 700;
      text-shadow: 0 0 12px rgba(245, 158, 11, 0.6), 0 0 24px rgba(245, 158, 11, 0.4);
    }

    .sidebar-close {
      cursor: pointer;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      color: var(--text-muted);
      transition: background 0.2s ease, color 0.2s ease;
      font-size: 20px;
      background: transparent;
      border: none;
      padding: 0;
    }

    .sidebar-close:hover {
      background: rgba(148, 163, 184, 0.1);
      color: var(--text-main);
    }

    .sidebar-menu {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sidebar-menu-item {
      margin-bottom: 8px;
    }

    .sidebar-menu-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 12px;
      color: var(--text-main);
      text-decoration: none;
      transition: background 0.2s ease, transform 0.1s ease;
      font-size: 14px;
    }

    .sidebar-menu-link:hover {
      background: rgba(56, 189, 248, 0.1);
      transform: translateX(4px);
    }

    .sidebar-menu-link.active {
      background: linear-gradient(90deg, rgba(56, 189, 248, 0.2), rgba(56, 189, 248, 0.1));
      border-radius: 10px;
      transform: translateX(2px);
    }

    .sidebar-menu-icon {
      font-size: 18px;
      width: 24px;
      text-align: center;
    }

    .sidebar-user {
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid rgba(148, 163, 184, 0.2);
      font-size: 13px;
      color: var(--text-muted);
    }

    @media (max-width: 640px) {
      .sidebar {
        width: 260px;
      }
    }

    .pdfs-mobile-view {
      display: none;
    }

    @media (max-width: 640px) {
      table, thead, tbody {
        display: none; /* Ocultar tabla en mobile */
      }

      .pdfs-mobile-view {
        display: block;
      }

      .pdf-card {
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 12px;
        padding: 14px;
        margin-bottom: 12px;
      }

      .pdf-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
        gap: 8px;
      }

      .pdf-card-name {
        font-weight: 600;
        font-size: 14px;
        color: var(--text-main);
        flex: 1;
        word-break: break-word;
      }

      .pdf-card-status {
        flex-shrink: 0;
      }

      .pdf-card-info {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 12px;
        color: var(--text-muted);
        margin-bottom: 12px;
      }

      .pdf-card-info-row {
        display: flex;
        justify-content: space-between;
      }

      .pdf-card-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 12px;
      }

      .pdf-card-button {
        width: 100%;
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid var(--accent);
        background: rgba(15, 23, 42, 0.95);
        color: var(--text-main);
        cursor: pointer;
        font-size: 12px;
        transition: all 0.15s ease;
        box-sizing: border-box;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 36px;
      }

      .pdf-card-button:hover:not(:disabled) {
        background: #020617;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(56, 189, 248, 0.25);
      }

      .pdf-card-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        min-height: 36px;
      }

      .pdf-card-link {
        color: var(--accent);
        text-decoration: none;
        font-size: 12px;
        display: inline-block;
        margin-top: 4px;
      }

      .pdf-card-actions .chunk-row-button,
      .pdf-card-actions .rag-button {
        margin-left: 0 !important;
        margin-right: 0 !important;
        padding: 8px 12px !important;
        width: 100% !important;
        border-radius: 8px !important;
        font-size: 12px !important;
      }
    }

    .user-name-header {
      font-size: 0.95rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      text-transform: capitalize;
      background: linear-gradient(120deg, #e5e7eb, #38bdf8);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
  </style>
</head>
<body>
  <!-- Fondo animado -->
  <div class="bg-aurora">
    <div class="aurora-blob"></div>
    <div class="aurora-blob"></div>
    <div class="aurora-blob"></div>
  </div>

  <!-- Navbar -->
  <nav style="position: fixed; top: 0; left: 0; right: 0; z-index: 1000; background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(148, 163, 184, 0.2); padding: 10px 16px;">
    <div style="max-width: 960px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap;">
      <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
        <button id="menuToggle" class="menu-icon" aria-label="Abrir men√∫">
          ‚ò∞
        </button>
        <span style="color: var(--text-muted);">|</span>
        <span id="navUserName" class="user-name-header"></span>
      </div>
      <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
        <button id="logoutBtn" style="padding: 6px 10px; border-radius: 8px; border: 1px solid var(--accent); background: transparent; color: var(--accent); cursor: pointer; font-size: 0.85rem; transition: all 0.2s;" onmouseover="this.style.background='rgba(56, 189, 248, 0.1)'" onmouseout="this.style.background='transparent'">Cerrar Sesi√≥n</button>
      </div>
    </div>
  </nav>

  <!-- Sidebar Overlay -->
  <div id="sidebarOverlay" class="sidebar-overlay"></div>

  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title"><span class="sidebar-brand-name">Marketing</span> <span class="sidebar-brand-number">360</span></div>
      <button id="sidebarClose" class="sidebar-close" aria-label="Cerrar men√∫">√ó</button>
    </div>
    <ul class="sidebar-menu">
      <li class="sidebar-menu-item">
        <a href="/pdfs.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">üìÑ</span>
          <span>Subir documentos</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="/rag.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">üí¨</span>
          <span>Mi chat</span>
        </a>
      </li>
      <li class="sidebar-menu-item">
        <a href="/metrics.html" class="sidebar-menu-link">
          <span class="sidebar-menu-icon">üìä</span>
          <span>M√©tricas del sistema</span>
        </a>
      </li>
    </ul>
    <div class="sidebar-user">
      Usuario: <span id="sidebarUserName"></span>
    </div>
  </aside>

  <div class="page-shell" style="margin-top: 60px;">
    <div class="card">
      <div class="top-bar">
        <div>
          <h1>DOCs subidos</h1>
          <p class="subtitle">Gestiona y consulta los documentos que has cargado al sistema.</p>
        </div>
        <div class="top-right">
          <div class="pill">Arrastra y suelta archivos PDF para subirlos r√°pidamente</div>
          <button class="refresh-button" onclick="loadPdfs()">
            <span class="icon">‚ü≤</span>
            <span>Recargar lista</span>
          </button>
        </div>
      </div>

      <div id="upload-area">
        <p>Arrastra aqu√≠ tus docs o haz clic para buscarlo en tu dispositivo.</p>
        <div class="upload-actions">
          <input id="pdf-input" type="file" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.md,.png,.jpg,.jpeg,.gif,.bmp,.tiff,.webp" style="display: none" />
          <button id="select-pdf-button" type="button">Seleccionar Documento</button>
          <button
            id="upload-button"
            type="button"
            disabled
            style="opacity: 0.5; cursor: not-allowed;"
          >
            <span class="progress-bg" id="upload-button-progress"></span>
            <span class="label" id="upload-button-label">Subir Documento</span>
          </button>
        </div>
        <p id="upload-status"></p>
      </div>

      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Tama√±o</th>
            <th>Estado</th>
            <th>Fecha</th>
            <th>Ver</th>
            <th>Rag</th>
          </tr>
        </thead>
        <tbody id="pdf-tbody">
          <tr>
            <td colspan="5">Cargando...</td>
          </tr>
        </tbody>
      </table>
      <div class="pdfs-mobile-view" id="pdfs-mobile-view"></div>
    </div>
  </div>

  <!-- Script de autenticaci√≥n -->
  <script type="module">
    import { checkAuth, getUser, logout, fetchWithAuth } from '/js/auth.js';

    // Verificar autenticaci√≥n al cargar
    if (!checkAuth()) {
      // Redirigir√° autom√°ticamente a login
    } else {
      // Mostrar nombre de usuario en navbar
      const user = getUser();
      if (user) {
        document.getElementById('navUserName').textContent = user.name || user.email;
      }
    }

    // Configurar event listener para logout cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', () => {
      const logoutButton = document.getElementById('logoutBtn');
      if (logoutButton) {
        logoutButton.addEventListener('click', (e) => {
          e.preventDefault();
          logout();
        });
      }
    });

    // Exportar fetchWithAuth para usar en el c√≥digo inline
    window.fetchWithAuth = fetchWithAuth;
  </script>

  <script>
    let selectedPdfFile = null;
    let lastUploadedPdfId = null; // Rastrear el √∫ltimo PDF subido
    let lastProcessedPdfId = null; // Rastrear el √∫ltimo PDF procesado

    async function uploadPdfFile(file) {
      const statusEl = document.getElementById("upload-status");
      const uploadButton = document.getElementById("upload-button");
      const uploadButtonProgress = document.getElementById("upload-button-progress");
      const uploadButtonLabel = document.getElementById("upload-button-label");

      // Reset estado UI
      uploadButtonProgress.style.width = "0%";
      statusEl.textContent = `Subiendo: ${file.name}...`;
      uploadButton.disabled = true;
      uploadButton.style.opacity = "0.7";
      uploadButton.style.cursor = "wait";
      uploadButtonLabel.textContent = "Subiendo...";

      const formData = new FormData();
      formData.append("doc", file); // nombre de campo esperado por el backend

      try {
        const xhr = new XMLHttpRequest();
        const token = localStorage.getItem('rag_auth_token');

        xhr.open("POST", "/api/pdf/upload", true);
        
        if (token) {
          xhr.setRequestHeader("Authorization", `Bearer ${token}`);
        }

        xhr.upload.onprogress = (event) => {
          if (event.lengthComputable) {
            const percent = Math.round((event.loaded / event.total) * 100);
            uploadButtonProgress.style.width = `${percent}%`;
            statusEl.textContent = `Subiendo: ${file.name} (${percent}%)`;
          }
        };

        xhr.onreadystatechange = async () => {
          if (xhr.readyState === 4) {
            if (xhr.status >= 200 && xhr.status < 300) {
              let data;
              try {
                data = JSON.parse(xhr.responseText || "{}");
              } catch (e) {
                data = { ok: false, message: "Respuesta inv√°lida del servidor" };
              }

              if (!data.ok) {
                throw new Error(data.message || "Error al subir el PDF");
              }

              uploadButtonProgress.style.width = "100%";
              statusEl.innerHTML = `Documento subido correctamente <span class="success-pulse">‚úì</span>`;
              uploadButtonLabel.textContent = "Subido";

              // Guardar el ID del PDF subido
              if (data.data && data.data.pdf && data.data.pdf._id) {
                lastUploadedPdfId = data.data.pdf._id;
                lastProcessedPdfId = null; // Resetear el procesado
              }

              // limpiar selecci√≥n
              selectedPdfFile = null;
              // Desactivar "Subir Documento"
              uploadButton.disabled = true;
              uploadButton.style.opacity = "0.5";
              uploadButton.style.cursor = "not-allowed";
              // Mantener "Seleccionar Documento" inactivo
              const selectPdfButton = document.getElementById("select-pdf-button");
              selectPdfButton.disabled = true;
              selectPdfButton.style.opacity = "0.5";
              selectPdfButton.style.cursor = "not-allowed";
              
              // recargar tabla
              await loadPdfs();

              // Reset visual despu√©s de un momento
              setTimeout(() => {
                uploadButtonProgress.style.width = "0%";
                uploadButtonLabel.textContent = "Subir Documento";
              }, 1200);
            } else {
              throw new Error("Error al subir el PDF");
            }
          }
        };

        xhr.onerror = () => {
          statusEl.textContent = "Error al subir el documento (problema de red).";
          uploadButtonProgress.style.width = "0%";
          uploadButtonLabel.textContent = "Subir Documento";
          uploadButton.disabled = false;
          uploadButton.style.opacity = "1";
          uploadButton.style.cursor = "pointer";
        };

        xhr.send(formData);
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error al subir el documento: " + err.message;
        uploadButtonProgress.style.width = "0%";
        uploadButtonLabel.textContent = "Subir Documento";
        uploadButton.disabled = false;
        uploadButton.style.opacity = "1";
        uploadButton.style.cursor = "pointer";
      }
    }
    
    async function processPdfFromRow(pdfId, button) {
      const statusEl = document.getElementById("upload-status");
      if (!pdfId) {
        statusEl.textContent = "No se encontr√≥ el ID del PDF para procesar.";
        return;
      }

      try {
        button.disabled = true;
        button.textContent = "Procesando...";
        button.style.opacity = "0.7";
        button.style.cursor = "wait";
        statusEl.textContent = "Procesando PDF en chunks...";

        const res = await fetchWithAuth(`/api/pdf/process/${pdfId}`, {
          method: "POST",
        });
        const data = await res.json();

        if (!res.ok || !data.ok) {
          throw new Error(data.message || "Error al procesar el PDF");
        }

        statusEl.innerHTML = `PDF procesado en ${data.chunks} chunks <span class="success-pulse">‚úì</span>`;

        // Guardar el ID del PDF procesado
        lastProcessedPdfId = pdfId;
        // Desactivar todos los botones "Convertir a chunks"
        const allChunkButtons = document.querySelectorAll(".chunk-row-button");
        allChunkButtons.forEach(b => {
          b.disabled = true;
          b.style.opacity = "0.5";
          b.style.cursor = "not-allowed";
        });

        await loadPdfs();

        setTimeout(() => {
          statusEl.textContent = "";
        }, 1500);
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error al procesar el PDF en chunks: " + err.message;
        button.disabled = false;
        button.textContent = "Convertir a chunks";
        button.style.opacity = "1";
        button.style.cursor = "pointer";
      }
    }

    function setupUploadArea() {
      const uploadArea = document.getElementById("upload-area");
      const fileInput = document.getElementById("pdf-input");
      const uploadButton = document.getElementById("upload-button");
      const selectPdfButton = document.getElementById("select-pdf-button");
      const statusEl = document.getElementById("upload-status");

      function setSelectedFile(file) {
        selectedPdfFile = file;
        const selectPdfButton = document.getElementById("select-pdf-button");
        
        if (file) {
          statusEl.textContent = `Seleccionado: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
          // Desactivar "Seleccionar Documento"
          selectPdfButton.disabled = true;
          selectPdfButton.style.opacity = "0.5";
          selectPdfButton.style.cursor = "not-allowed";
          // Activar "Subir Documento"
          uploadButton.disabled = false;
          uploadButton.style.opacity = "1";
          uploadButton.style.cursor = "pointer";
        } else {
          statusEl.textContent = "";
          // Activar "Seleccionar Documento"
          selectPdfButton.disabled = false;
          selectPdfButton.style.opacity = "1";
          selectPdfButton.style.cursor = "pointer";
          // Desactivar "Subir Documento"
          uploadButton.disabled = true;
          uploadButton.style.opacity = "0.5";
          uploadButton.style.cursor = "not-allowed";
        }
      }

      // Click en "Seleccionar Documento" - abre el di√°logo de selecci√≥n de archivos
      selectPdfButton.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        fileInput.click();
      });

      // Click en el √°rea de upload - tambi√©n abre el di√°logo de selecci√≥n de archivos
      uploadArea.addEventListener("click", (e) => {
        // Solo abrir el di√°logo si el click no fue en un bot√≥n u otro elemento interactivo
        const clickedElement = e.target;
        const isButton = clickedElement.tagName === "BUTTON" || clickedElement.closest("button");
        const isInput = clickedElement.tagName === "INPUT";
        
        if (!isButton && !isInput) {
          fileInput.click();
        }
      });

      // Click en "Subir Documento"
      uploadButton.addEventListener("click", () => {
        if (!selectedPdfFile) {
          statusEl.textContent = "Primero selecciona un archivo.";
          return;
        }
        uploadPdfFile(selectedPdfFile);
      });

      // Cambio por selecci√≥n manual
      fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          const allowedTypes = [
            "application/pdf",
            "application/msword",
            "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
            "application/vnd.ms-excel",
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            "application/vnd.ms-powerpoint",
            "application/vnd.openxmlformats-officedocument.presentationml.presentation",
            "text/plain",
            "text/markdown",
            "text/x-markdown",
            "image/png",
            "image/jpeg",
            "image/jpg",
            "image/gif",
            "image/bmp",
            "image/tiff",
            "image/webp",
          ];
          
          if (!allowedTypes.includes(file.type)) {
            statusEl.textContent = "Tipo de archivo no permitido. Formatos soportados: PDF, DOC, DOCX, XLS, XLSX, TXT, MD, im√°genes.";
            setSelectedFile(null);
            return;
          }
          setSelectedFile(file);
        }
      });

      // Eventos drag & drop
      ["dragenter", "dragover"].forEach((eventName) => {
        uploadArea.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
          uploadArea.classList.add("drag-over");
        });
      });

      ["dragleave", "drop"].forEach((eventName) => {
        uploadArea.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
          uploadArea.classList.remove("drag-over");
        });
      });

      uploadArea.addEventListener("drop", (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        if (files && files[0]) {
          const file = files[0];
          const allowedTypes = [
            "application/pdf",
            "application/msword",
            "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
            "application/vnd.ms-excel",
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            "application/vnd.ms-powerpoint",
            "application/vnd.openxmlformats-officedocument.presentationml.presentation",
            "text/plain",
            "text/markdown",
            "text/x-markdown",
            "image/png",
            "image/jpeg",
            "image/jpg",
            "image/gif",
            "image/bmp",
            "image/tiff",
            "image/webp",
          ];
          
          if (!allowedTypes.includes(file.type)) {
            statusEl.textContent = "Tipo de archivo no permitido. Formatos soportados: PDF, DOC, DOCX, XLS, XLSX, TXT, MD, im√°genes.";
            setSelectedFile(null);
            return;
          }
          setSelectedFile(file);
        }
      });
    }

    async function loadPdfs() {
      const tbody = document.getElementById("pdf-tbody");
      const mobileView = document.getElementById('pdfs-mobile-view');
      
      if (tbody) {
        tbody.innerHTML = "<tr><td colspan='5'>Cargando...</td></tr>";
      }
      if (mobileView) {
        mobileView.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">Cargando...</div>';
      }
      
      try {
        const res = await fetchWithAuth("/api/pdf");
        const data = await res.json();

        if (!data.ok) {
          if (tbody) {
            tbody.innerHTML = `<tr><td colspan="5">Error: ${data.message}</td></tr>`;
          }
          if (mobileView) {
            mobileView.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--error);">Error: ${data.message}</div>`;
          }
          return;
        }

        if (!data.data?.pdfs?.length) {
          if (tbody) {
            tbody.innerHTML = "<tr><td colspan='5'>No hay PDFs subidos a√∫n.</td></tr>";
          }
          if (mobileView) {
            mobileView.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No hay PDFs subidos a√∫n.</div>';
          }
          return;
        }

        tbody.innerHTML = "";
        data.data.pdfs.forEach((pdf) => {
          const tr = document.createElement("tr");

          const sizeKb = (pdf.size / 1024).toFixed(1);

          const createdAt = pdf.createdAt
            ? new Date(pdf.createdAt).toLocaleString()
            : "-";

          const link = `/uploads/${pdf.fileName}`;
          
          const isProcessed = pdf.status === "processed";
          const isLastUploaded = pdf._id === lastUploadedPdfId;
          const isLastProcessed = pdf._id === lastProcessedPdfId;
          // Solo activar "Convertir a chunks" si es el √∫ltimo subido y no est√° procesado
          const shouldEnableChunk = isLastUploaded && !isProcessed && !lastProcessedPdfId;
          // Solo activar "Enviar a Qdrant" si es el √∫ltimo procesado
          const shouldEnableRag = isLastProcessed && isProcessed;

tr.innerHTML = `
  <td>${pdf.originalName}</td>
  <td>${sizeKb} KB</td>
  <td><span class="tag">${pdf.status || "uploaded"}</span></td>
  <td>${createdAt}</td>
  <td>
    <a href="${link}" target="_blank">Abrir</a>
    <button
      class="chunk-row-button"
      data-pdf-id="${pdf._id || ""}"
      ${shouldEnableChunk
        ? "style='margin-left:6px;'"
        : "disabled style='margin-left:6px;opacity:0.5;cursor:not-allowed;'"}
    >
      Convertir a chunks
    </button>
  </td>
  <td>
    <button
      class="rag-button"
      data-pdf-id="${pdf._id || ""}"
      ${shouldEnableRag
        ? ""
        : "disabled style='opacity:0.5;cursor:not-allowed;'"}
    >
      Enviar a Qdrant
    </button>
  </td>
`;


          tbody.appendChild(tr);
        });

        // Generar vista mobile
        const mobileView = document.getElementById('pdfs-mobile-view');
        if (mobileView) {
          mobileView.innerHTML = '';
          data.data.pdfs.forEach((pdf) => {
            const card = document.createElement('div');
            card.className = 'pdf-card';
            
            const sizeKb = (pdf.size / 1024).toFixed(1);
            const createdAt = pdf.createdAt
              ? new Date(pdf.createdAt).toLocaleString()
              : "-";
            const link = `/uploads/${pdf.fileName}`;
            const isProcessed = pdf.status === "processed";
            const isLastUploaded = pdf._id === lastUploadedPdfId;
            const isLastProcessed = pdf._id === lastProcessedPdfId;
            // Solo activar "Convertir a chunks" si es el √∫ltimo subido y no est√° procesado
            const shouldEnableChunk = isLastUploaded && !isProcessed && !lastProcessedPdfId;
            // Solo activar "Enviar a Qdrant" si es el √∫ltimo procesado
            const shouldEnableRag = isLastProcessed && isProcessed;
            
            card.innerHTML = `
              <div class="pdf-card-header">
                <div class="pdf-card-name">${pdf.originalName}</div>
                <div class="pdf-card-status">
                  <span class="tag">${pdf.status || "uploaded"}</span>
                </div>
              </div>
              <div class="pdf-card-info">
                <div class="pdf-card-info-row">
                  <span>Tama√±o:</span>
                  <span>${sizeKb} KB</span>
                </div>
                <div class="pdf-card-info-row">
                  <span>Fecha:</span>
                  <span>${createdAt}</span>
                </div>
              </div>
              <div class="pdf-card-actions">
                <button
                  class="pdf-card-button chunk-row-button"
                  data-pdf-id="${pdf._id || ""}"
                  ${shouldEnableChunk ? "" : "disabled"}
                >
                  ${shouldEnableChunk ? "Convertir a chunks" : (isProcessed ? "‚úì Procesado" : "Convertir a chunks")}
                </button>
                <button
                  class="pdf-card-button rag-button"
                  data-pdf-id="${pdf._id || ""}"
                  ${shouldEnableRag ? "" : "disabled"}
                >
                  ${shouldEnableRag ? "Enviar a Qdrant" : (isProcessed ? "Enviar a Qdrant" : "‚è≥ Procesa primero")}
                </button>
              </div>
            `;
            
            mobileView.appendChild(card);
          });
        }

        // asociar eventos a los botones "Convertir a chunks" de cada fila (tanto en tabla como en cards)
        const chunkButtons = document.querySelectorAll(".chunk-row-button");
        chunkButtons.forEach((btn) => {
          const pdfId = btn.getAttribute("data-pdf-id");
          if (!pdfId || btn.disabled) return;
          btn.addEventListener("click", () => processPdfFromRow(pdfId, btn));
        });

       // asociar eventos a los botones "Enviar a Qdrant" (RAG) (tanto en tabla como en cards)
const ragButtons = document.querySelectorAll(".rag-button");
ragButtons.forEach((btn) => {
  const pdfId = btn.getAttribute("data-pdf-id");
  if (!pdfId || btn.disabled) return;

  btn.addEventListener("click", async () => {
    const statusEl = document.getElementById("upload-status");
    try {
      btn.disabled = true;
      btn.textContent = "Embebiendo...";
      btn.style.opacity = "0.7";
      btn.style.cursor = "wait";
      statusEl.textContent = "Generando embeddings y enviando a Qdrant...";

      const res = await fetchWithAuth(`/api/pdf/embed/${pdfId}`, {
        method: "POST",
      });
      const data = await res.json();

      if (!res.ok || !data.ok) {
        throw new Error(data.message || "Error al generar embeddings");
      }

      statusEl.innerHTML = `Embeddings generados (${data.inserted}) <span class="success-pulse">‚úì</span>`;
      btn.textContent = "Enviado ‚úì";
      btn.disabled = true;
      btn.style.opacity = "0.5";
      btn.style.cursor = "not-allowed";

      // Desactivar todos los botones excepto "Seleccionar Documento"
      const allChunkButtons = document.querySelectorAll(".chunk-row-button");
      allChunkButtons.forEach(b => {
        b.disabled = true;
        b.style.opacity = "0.5";
        b.style.cursor = "not-allowed";
      });

      const allRagButtons = document.querySelectorAll(".rag-button");
      allRagButtons.forEach(b => {
        b.disabled = true;
        b.style.opacity = "0.5";
        b.style.cursor = "not-allowed";
      });

      // Limpiar el rastreo
      lastUploadedPdfId = null;
      lastProcessedPdfId = null;

      // Reactivar "Seleccionar Documento"
      const selectPdfButton = document.getElementById("select-pdf-button");
      if (selectPdfButton) {
        selectPdfButton.disabled = false;
        selectPdfButton.style.opacity = "1";
        selectPdfButton.style.cursor = "pointer";
      }

      // refrescar listado para ver cambios de estado
      await loadPdfs();

      setTimeout(() => {
        statusEl.textContent = "";
      }, 2000);
    } catch (err) {
      console.error(err);
      statusEl.textContent = "Error al enviar a Qdrant: " + err.message;
      btn.disabled = false;
      btn.textContent = "Enviar a Qdrant";
      btn.style.opacity = "1";
      btn.style.cursor = "pointer";
    }
  });
});


      } catch (err) {
        console.error(err);
        const mobileView = document.getElementById('pdfs-mobile-view');
        if (tbody) {
          tbody.innerHTML = "<tr><td colspan='5'>Error al cargar la lista.</td></tr>";
        }
        if (mobileView) {
          mobileView.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--error);">Error al cargar la lista.</div>';
        }
      }
    }

    // Evitar que el navegador abra el archivo al soltarlo fuera del √°rea
    window.addEventListener("dragover", (e) => e.preventDefault());
    window.addEventListener("drop", (e) => e.preventDefault());

    // Inicializar al cargar
    document.addEventListener("DOMContentLoaded", () => {
      setupUploadArea();
      loadPdfs();
      
      // Estado inicial: solo "Seleccionar Documento" activo
      const selectPdfButton = document.getElementById("select-pdf-button");
      const uploadButton = document.getElementById("upload-button");
      if (selectPdfButton) {
        selectPdfButton.disabled = false;
        selectPdfButton.style.opacity = "1";
        selectPdfButton.style.cursor = "pointer";
      }
      if (uploadButton) {
        uploadButton.disabled = true;
        uploadButton.style.opacity = "0.5";
        uploadButton.style.cursor = "not-allowed";
      }
    });

    // Sidebar functionality
    document.addEventListener('DOMContentLoaded', () => {
      const menuToggle = document.getElementById('menuToggle');
      const sidebar = document.getElementById('sidebar');
      const sidebarOverlay = document.getElementById('sidebarOverlay');
      const sidebarClose = document.getElementById('sidebarClose');
      const sidebarUserName = document.getElementById('sidebarUserName');
      const navUserName = document.getElementById('navUserName');

      // Sincronizar nombre de usuario en sidebar
      if (navUserName && sidebarUserName) {
        const updateSidebarUser = () => {
          sidebarUserName.textContent = navUserName.textContent;
        };
        updateSidebarUser();
        // Observar cambios en el nombre de usuario
        const observer = new MutationObserver(updateSidebarUser);
        observer.observe(navUserName, { childList: true, subtree: true });
      }

      // Marcar p√°gina activa seg√∫n la URL actual
      const currentPath = window.location.pathname;
      const sidebarLinks = sidebar.querySelectorAll('.sidebar-menu-link');
      sidebarLinks.forEach(link => {
        const linkPath = new URL(link.href).pathname;
        if (linkPath === currentPath) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      });

      function openSidebar() {
        sidebar.classList.add('active');
        sidebarOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      function closeSidebar() {
        sidebar.classList.remove('active');
        sidebarOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }

      // Abrir sidebar
      if (menuToggle) {
        menuToggle.addEventListener('click', (e) => {
          e.stopPropagation();
          openSidebar();
        });
      }

      // Cerrar sidebar
      if (sidebarClose) {
        sidebarClose.addEventListener('click', closeSidebar);
      }

      // Cerrar al hacer click en overlay
      if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', closeSidebar);
      }

      // Cerrar al hacer click en un link del men√∫
      sidebarLinks.forEach(link => {
        link.addEventListener('click', () => {
          // Peque√±o delay para que se vea la navegaci√≥n
          setTimeout(closeSidebar, 100);
        });
      });

      // Cerrar con ESC
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && sidebar.classList.contains('active')) {
          closeSidebar();
        }
      });
    });
  </script>
</body>
</html>

